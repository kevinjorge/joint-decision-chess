{% extends 'main/base.html' %}

{% load static %}

{% block style %} 
<!-- Allow table of contents featuring introduction -->
<style>
    .homeblock {
        height: 10%;
    }

    .sidenav {
        height: 90%;
    }

    html {
        scroll-behavior: smooth;
    }

    .new-game {
        color: white;
        border: none;
        outline: none;
        background-color: #6c757d;
        transition: background-color 0.3s ease;
        transition: color 0.3s ease;
    }

    .new-game:focus {
        outline: none;
    }

    .new-game:hover {
        background-color: rgb(161, 161, 161);
        color: #7685d8
    }

    .lobby {
        background-color: #d9e3f3;
        color: black;
        outline-style: solid;
        outline-width: thin;
        outline-color: rgb(146, 146, 146);
        max-width: 100%;
        position: relative;
        padding-bottom: 63%;
    }

    .lobby-header {
        text-align: center; 
        padding-bottom: 0.5em; 
        position: sticky; 
        top: 0; 
        background-color: #d9e3f3;
    }

    .scrollable-lobby-list {
        position: absolute;
        max-height: 100%;
        overflow-y: auto;
        z-index: 1;
    }

    .lobby-row {
        border: none;
        border-bottom: solid 0.05em #778498;
        outline: none;
        min-width: 100%;
        background-color: transparent;
        transition: background-color 0.3s ease;
        transition: color 0.1s ease;
    }

    .lobby-row:disabled {
        color: rgb(172, 172, 172);
        background-color: rgba(125, 131, 140, 0.7);
    }

    .lobby-row:disabled:hover {
        color: rgb(172, 172, 172);
        background-color: rgba(194, 152, 133, 0.7);
    }

    .lobby-row:focus {
        outline: none;
    }
    
    .lobby-row:hover {
        color: white;
        background-color: rgba(190, 176, 126, 0.7);
    }

    .lobby-row.empty:hover {
        color: black;
        background-color: rgba(166, 174, 186, 0.7);
    }

</style>
{% endblock %}

{% block title %}
Decision Chess
{% endblock %}

{% block side_head_content %}
    <a href="#Introduction" style="font-size: 15px;">Introduction</a>
{% endblock %}

{% block content %}
<div id="content", name="content", class="main">
    <div class="row justify-content-center" style="max-width: 100%;"> <!-- max width necessary for no horizontal scrolling -->
        <!-- Landing Section across 11 columns -->
        <div class="col-3">
        </div>
        <!-- Join column: Quick Pair, Lobby, games in play section -->
        <div class="col-5">
            <!-- <img src="{% static 'main/images/coming-soon-landing.png' %}" alt="Join Section" style="max-width: 100%;"> -->
            <div class="lobby" class="" style="max-width: 100%;">
                <div id="lobby-list" class="scrollable-lobby-list" style="min-width: 100%;">
                    <div class="lobby-header">User (Anonymous)</div>
                    <div id="lobby-content"></div>
                </div>
            </div>
        </div>
        <!-- Game creation, live stats -->
        <div class="col-3 d-flex align-items-center">
            <button class="new-game" style="min-width: 100%;">Create New Game</button>
        </div>
        <!-- Top live game, Recent News, donation section to be added here -->
        <!-- Introduction Section across 11 columns -->
        <!-- Empty -->
        <div class="col-3">
        </div>
        <!-- Introduction -->
        <div class="col-5">
            <section id="Introduction">
                <h2>Introduction</h2>
                <p>
                    Decision Chess is a variant of chess that will require the move of each player to be locked in before playing them, 
                    additionally there are no turns during "active" play. That is, both players can move their pieces on the same turn and both 
                    moves will be played at the same time once they both agree to proceed. 
                    <br>
                    The full official name of the variant is thus called <strong><em>Joint</em>-Decision Chess</strong>, but that's less catchy.
                    <br>
                    <br>
                    Currently, this site only offers the classical standard version of chess while basic functionality is developed and enabled.
                    It will allow for classical games and decision chess games in the future. The following is a list of some major upcoming features and pages. <br>
                    Stay tuned...
                </p>
                <ul>
                    <li>A News Page</li>
                    <li>A Play Page that interacts with the game</li>
                    <li>A Profile Page</li>
                    <li>An Account Page</li>
                    <li>Enabling Multiplayer</li>
                    <li>Revisiting Old Games</li>
                    <li>Home Page Lobby and Quick Pair Tabs</li>
                    <li>Live Chatbox</li>
                    <li>AI opponents</li>
                    <li>Theme set selection</li>
                    <li>Lobby game filter</li>
                    <li>Potential Visual Overhaul</li>
                </ul>
                <p>Once this initial site is complete, I will begin to create and implement my variant. The following is a list of features coming with the beta version:</p>
                <ul>
                    <li>Implementing the new variant itself!</li>
                    <li>Creating AI and iterating on the design through Generative Adversarial Networks</li>
                    <li>A personal notes tab alongside the live chat</li>
                    <li>Customizing the variant</li>
                    <li>Mobile compatibility</li>
                    <li>Live games viewing</li>
                    <li>Personal Ranking System (Not ELO)</li>
                    <li>Players Page with Leaderboards and Search</li>
                    <li>Tools Page with board editor and game search</li>
                    <li>Creating, testing, and adding sub-variants!</li>
                    <li>Many more minor features...</li>
                </ul>
                <p>After these major hurdles and non-referenced other tasks are complete I will wait for feedback that will be added to version 1.0. <br> 
                   I have only optional dependent features after it's initial launch but will await feedback and prioritize.
                </p>
            </section>
        </div>
        <!-- Empty -->
        <div class="col-3">
        </div>
    </div>
    <script>
        function generateGameURL() {
			fetch('/create_new_game/')
				.then(response => {
					if (response.redirected) {
						window.location.href = response.url;
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
		}
        const newGameButtons = document.querySelectorAll('.new-game');
        newGameButtons.forEach(button => {
            button.addEventListener('click', generateGameURL);
        });

        function updateLobby() {
            var lobbyListContainer = document.getElementById('lobby-content');

            fetch('/get_lobby_games/')
                .then(response => response.json())
                .then(data => {
                    lobbyListContainer.innerHTML = ''
                    if (data.length === 0) {
                        var noGamesMessage = document.createElement('button');
                        noGamesMessage.className = "lobby-row empty";
                        noGamesMessage.textContent = 'No games available...';
                        noGamesMessage.style.borderBottom = "none";
                        lobbyListContainer.appendChild(noGamesMessage);
                    }
                    // Later limit it to a set number
                    data.forEach((game, index) => {
                        var lobbyRow = document.createElement('button');
                        lobbyRow.className = "lobby-row";
                        lobbyRow.textContent = game.initiator_name;

                        var gameLink = document.createElement('a');
                        gameLink.href = '/play/' + game.game_uuid;
                        gameLink.onclick = function (event) {
                            event.preventDefault();
                            checkGameAvailability(game.game_uuid, gameLink, lobbyRow);
                        };
                        gameLink.appendChild(lobbyRow);

                        if (index === data.length - 1) {
                            lobbyRow.style.borderBottom = "none";
                        }
                        lobbyListContainer.appendChild(gameLink);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        var csrftoken = Cookies.get('csrftoken');

        function checkGameAvailability(gameId, gameLink, lobbyRow) {
            fetch('/check_game_availability/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ gameId: gameId }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.open) {
                        window.location.href = '/play/' + gameId;
                    } else {
                        lobbyRow.disabled = true
                    }
                })
                .catch(error => {
                    console.error('Error checking game availability:', error);
                });
        }

        window.addEventListener('load', updateLobby);
        setInterval(updateLobby, 50000);
    </script>
</div>
{% endblock %}